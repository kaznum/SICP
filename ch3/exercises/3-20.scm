(define (cons x y)
  (define (set-x! v) (set! x v))
  (define (set-y! v) (set! y v))
  (define (dispatch m)
    (cond ((eq? m 'car) x)
          ((eq? m 'cdr) y)
          ((eq? m 'set-car!) set-x!)
          ((eq? m 'set-cdr!) set-y!)
          (else (error "Undefined operation -- CONS" m))))
  dispatch)
(define (car z) (z 'car))
(define (cdr z) (z 'cdr))
(define (set-car! z new-value)
  ((z 'set-car!) new-value)
  z)
(define (set-cdr! z new-value)
  ((z 'set-cdr!) new-value)
  z)


(define x (cons 1 2))
(define z (cons x x))
(set-car! (cdr z) 17)
(car x)


;;;; (define x (cons 1 2))

;;          +-------------------------------------------------------------+
;; global   |  cons -------------------------------------------+          |
;;          |  car                                             |          |
;;          |  cdr                                             |          |
;;          |  set-car!                                        |          |
;;          |  set-cdr!                                        |          |
;;          |  x -------+                                      |          |
;;          +-----------|--------------------------------------+----------+
;;                      |         ^                            |       ^
;;                      |         |                            v       |
;;                      |      +------------+              +---+---+   |
;;                      |      | x: 1       |              | * | *-+---+
;;                      |      | y: 2       |              +-+-+---+
;;                      |E1--> | set-x!     |                |
;;                      |      | set-y!     |                v
;;                      |      | dispatch   |          params: x, y
;;                      |      +------------+          body: (define (set-x! ....
;;                      v           ^
;;                  +---+---+       |
;;                  | * | *-+-------+
;;                  +-+-+---+
;;                    |
;;                    |
;;                    v
;;              params: m
;;              body: the body of dispatch

;;;; (define z (cons x x))
;;          +---------------------------------------------------------------------------------+
;; global   |  cons ---------------------------------------------------------------+          |
;;          |  car                                                                 |          |
;;          |  cdr                                                                 |          |
;;          |  set-car!                                                            |          |
;;          |  set-cdr!                                                            |          |
;;          |  x -------+                                                          |          |
;;          |  z --------------------------------+                                 |          |
;;          +-----------|------------------------|---------------------------------+----------+
;;                      |         ^              |            ^                    |       ^
;;                      |         |              |            |                    v       |
;;                      |      +------------+    |        +------------+       +---+---+   |
;;                      |      | x: 1       |    |        | x: x       |       | * | *-+---+
;;                      |      | y: 2       |    |        | y: x       |       +-+-+---+
;;                      |E1--> | set-x!     |    |  E2--> | set-x!     |         |
;;                      |      | set-y!     |    |        | set-y!     |         v
;;                      |      | dispatch   |    |        | dispatch   |       params: x, y
;;                      |      +------------+    |        +------------+       body: (define (set-x! ....
;;                      v           ^            |             ^
;;                  +---+---+       |        +---+---+         |
;;                  | * | *-+-------+        | * | *-+---------+
;;                  +-+-+---+                +-+-+---+
;;                    |                        |
;;                    |  +---------------------+
;;                    |  |
;;                    v  v
;;            params: m
;;            body: body of dispatch


;;; (set-car! (cdr z) 17)
;;          +-------------------------------------------------------------------------------------------------------------+
;; global   |  cons -------------------------------------------------------------------------------------------+          |
;;          |  car                                                                                             |          |
;;          |  cdr                                                                                             |          |
;;          |  set-car!                                                                                        |          |
;;          |  set-cdr!                                                                                        |          |
;;          |  x -------+                                                                                      |          |
;;          |  z --------------------------------+                                                             |          |
;;          +-----------|------------------------|-------------------------------------------------------------+----------+
;;                      |         ^              |            ^                ^            ^                  |       ^
;;                      |         |              |            |                |            |                  v       |
;;                      |      +-------------+   |        +------------+       |      +---------------+    +---+---+   |
;;                      |      | x: 1 -> 17  |   |        | x: x       |       |      | z: x          |    | * | *-+---+
;;                      |      | y: 2        |   |        | y: x       |       | E4-->| new-value: 17 |    +-+-+---+
;;                      |E1--> | set-x!      |   |  E2--> | set-x!     |       |      +---------------+      |
;;                      |      | set-y!      |   |        | set-y!     |       |       call to set-car!      v
;;                      |      | dispatch    |   |        | dispatch   |       |                          params: x, y
;;                      |      +-------------+   |        +------------+       |                          body: (define (set-x! ....
;;                      v        ^   ^     ^     |             ^  ^            |
;;                  +---+---+    |   |     | +---+---+         |  |            |
;;                  | * | *-+----+   |     | | * | *-+---------+  |            |
;;                  +-+-+---+        |     | +-+-+---+            |            |
;;                    |              |     |   |                  |            |
;;                    |  +---------------------+           +------+--+       +-+-----+
;;                    |  |           |     |        E3'--> | m: 'cdr |  E3-->| z: z  |
;;                    v  v           |     |               +---------+	     +-------+
;;           params: m               |     |            call to dispatch    call to cdr
;;           body: body of dispatch  |     |
;;                                   |     |
;;                        +------------+ +--------+
;;                  E5 -->|m: 'set-car | | v: 17  |<-- E6
;;                        +------------+ +--------+
;;                      call to dispatch  call to set-x!
;;
;;
;;
;;;; (car x)
;;          +-------------------------------------------------------------------------------+
;; global   |  cons -------------------------------------------------------------+          |
;;          |  car                                                               |          |
;;          |  cdr                                                               |          |
;;          |  set-car!                                                          |          |
;;          |  set-cdr!                                                          |          |
;;          |  x -------+                                                        |          |
;;          |  z --------------------------------+                               |          |
;;          +-----------|------------------------|-------------------------------+----------+
;;                      |         ^              |            ^           ^      |       ^
;;                      |         |              |            |           |      v       |
;;                      |      +-------------+   |        +------------+  |   +---+---+  |
;;                      |      | x: 17       |   |        | x: x       |  |   | * | *-+--+
;;                      |      | y: 2        |   |        | y: x       |  |   +-+-+---+
;;                      |E1--> | set-x!      |   |  E2--> | set-x!     |  |     |
;;                      |      | set-y!      |   |        | set-y!     |  |     v
;;                      |      | dispatch    |   |        | dispatch   |  |    params: x, y
;;                      |      +-------------+   |        +------------+  |    body: (define (set-x! ....
;;                      v        ^   ^           |             ^          |
;;                  +---+---+    |   |       +---+---+         |          |
;;                  | * | *-+----+   |       | * | *-+---------+          |
;;                  +-+-+---+        |       +-+-+---+                    |
;;                    |              |         |                          |
;;                    |  +---------------------+                          |
;;                    |  |           |                               +----+-----+
;;                    v  v           |                         E7 -->| z: x     |
;;           params: m               |                               +----------+
;;           body: body of dispatch  |                               call to car
;;                                   |
;;                        +------------+
;;                  E8 -->| m: 'car    |
;;                        +------------+
;;                      call to dispatch
;;
